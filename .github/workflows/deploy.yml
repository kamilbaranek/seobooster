name: Deploy to DigitalOcean

on:
 push:
    branches: [ main ]

jobs:
    deploy:
      runs-on: ubuntu-latest

      steps:
        - name: Deploy over SSH
          uses: appleboy/ssh-action@v1.0.3
          with:
            host: ${{ secrets.DO_HOST }}
            username: ${{ secrets.DO_USER }}
            key: ${{ secrets.DO_SSH_KEY }}
            script: |
              set -e

              cd /var/www/seobooster
              # Git safe directory (kvůli dřívější chybě)
              git config --global --add safe.directory /var/www/seobooster
              
              # nvm + Node 22
              export NVM_DIR="$HOME/.nvm"
              [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
              nvm use 22

              # stáhni poslední změny
              git fetch origin main
              git reset --hard origin/main

              # instalace/aktualizace závislostí (prod režim)
              npm ci

              # databázové migrace (produkční režim)
              # pouze pokud bude DEV databáze a PROD databáze jiná
              # npx prisma migrate deploy

              # build všech apps (api, web, worker)
              npm run build

              # reload všech procesů přes ecosystem.config.js
              pm2 reload ecosystem.config.js --env production

              # volitelné: zapiš stav a ulož PM2 config
              pm2 save
