generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  ADMIN
  SUPERADMIN
}

enum SubscriptionStatus {
  INCOMPLETE
  INCOMPLETE_EXPIRED
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
  UNPAID
}

enum WebStatus {
  PENDING_PAYMENT
  ACTIVE
  PAUSED
  ERROR
}

enum IntegrationType {
  NONE
  WORDPRESS_APPLICATION_PASSWORD
  WORDPRESS_OAUTH
  CUSTOM_API
}

enum ArticleStatus {
  DRAFT
  QUEUED
  PUBLISHED
}

enum ArticlePlanStatus {
  PLANNED
  QUEUED
  GENERATED
  PUBLISHED
  SKIPPED
}

enum AssetStatus {
  PENDING
  SUCCESS
  FAILED
}

enum WordpressTagsMode {
  AUTO_FROM_KEYWORDS
  MANUAL_ONLY
}

model User {
  id               String   @id @default(cuid())
  email            String   @unique
  passwordHash     String
  resetToken       String?  @unique
  resetTokenExpires DateTime?
  role             UserRole @default(USER)
  stripeCustomerId String?  @unique
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  subscriptions Subscription[]
  webs          Web[]
}

model Subscription {
  id                    String             @id @default(cuid())
  user                  User               @relation(fields: [userId], references: [id])
  userId                String
  stripeSubscriptionId  String             @unique
  status                SubscriptionStatus
  planId                String?
  currentPeriodStart    DateTime?
  currentPeriodEnd      DateTime?
  imageGenerationLimit  Int                @default(3)
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt

  webs Web[]
}

model Web {
  id              String          @id @default(cuid())
  user            User            @relation(fields: [userId], references: [id])
  userId          String
  subscription    Subscription?   @relation(fields: [subscriptionId], references: [id])
  subscriptionId  String?
  url             String          @unique
  nickname        String?
  status          WebStatus       @default(PENDING_PAYMENT)
  integrationType IntegrationType @default(NONE)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  credentials                   WebCredentials?
  products                      WebProduct[]
  analysis                      WebAnalysis?
  articles                      Article[]
  articlePlans                  ArticlePlan[]
  aiCallLogs                    AiCallLog[]
  seoStrategies                 SeoStrategy[]
  magicLinks                    MagicLink[]
  aiCosts                       AiCost[]

  faviconUrl                    String?
  faviconSourceUrl              String?
  faviconStatus                 AssetStatus            @default(PENDING)
  faviconLastFetchedAt          DateTime?
  screenshotUrl                 String?
  screenshotStatus              AssetStatus            @default(PENDING)
  screenshotLastGeneratedAt     DateTime?
  screenshotWidth               Int?
  screenshotHeight              Int?
  articleImageGenerationEnabled Boolean                @default(true)
  wordpressTagsMode             WordpressTagsMode      @default(AUTO_FROM_KEYWORDS)
  defaultWordpressCategory      WebWordpressCategory?  @relation("WebDefaultCategory", fields: [defaultWordpressCategoryId], references: [id])
  defaultWordpressCategoryId    String?                @unique
  defaultWordpressAuthor        WebWordpressAuthor?    @relation("WebDefaultAuthor", fields: [defaultWordpressAuthorId], references: [id])
  defaultWordpressAuthorId      String?                @unique
  wordpressCategories           WebWordpressCategory[]
  wordpressAuthors              WebWordpressAuthor[]
  publicationSchedule           String[]               @default([])
  timezone                      String                 @default("UTC")
  language                      String                 @default("en")
  country                       String                 @default("")
  
  // Onboarding & Trial
  trialEndsAt       DateTime?
  onboardingStep    Int                    @default(0)
  projectType       String?                // "commercial" | "non_commercial"
  webAge            String?                // "new" | "history"
  platform          String?                // "wordpress" | "shopify" | "wix" | "other"
  businessGoal      String[]               @default([])
  audience          Json?
  competitors       Json?
  conversionGoal    String?
}

model WebWordpressCategory {
  id        String   @id @default(cuid())
  web       Web      @relation(fields: [webId], references: [id], onDelete: Cascade)
  webId     String
  name      String
  slug      String?
  remoteId  Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  articles      Article[]
  defaultForWeb Web?      @relation("WebDefaultCategory")

  @@unique([webId, remoteId])
  @@index([webId])
}

model WebWordpressAuthor {
  id        String   @id @default(cuid())
  web       Web      @relation(fields: [webId], references: [id], onDelete: Cascade)
  webId     String
  name      String
  slug      String?
  remoteId  Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  articles      Article[]
  defaultForWeb Web?      @relation("WebDefaultAuthor")

  @@unique([webId, remoteId])
  @@index([webId])
}

model WebCredentials {
  id            String   @id @default(cuid())
  web           Web      @relation(fields: [webId], references: [id])
  webId         String   @unique
  encryptedJson String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model WebAnalysis {
  id              String    @id @default(cuid())
  web             Web       @relation(fields: [webId], references: [id], onDelete: Cascade)
  webId           String    @unique
  lastScanAt      DateTime?
  scanResult      Json?
  businessProfile Json?
  seoStrategy     Json?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model Article {
  id                  String                @id @default(cuid())
  web                 Web                   @relation(fields: [webId], references: [id])
  webId               String
  title               String
  status              ArticleStatus         @default(DRAFT)
  url                 String?
  markdown            String
  html                String
  wordpressPostId     String?
  tags                Json?
  featuredImageUrl    String?
  wordpressCategory   WebWordpressCategory? @relation(fields: [wordpressCategoryId], references: [id])
  wordpressCategoryId String?
  wordpressAuthor     WebWordpressAuthor?   @relation(fields: [wordpressAuthorId], references: [id])
  wordpressAuthorId   String?
  publishedAt         DateTime?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt

  approvalTokens ArticleApprovalToken[]
  plan           ArticlePlan?           @relation("ArticlePlanArticle")
  planVersion    ArticlePlan?           @relation("ArticlePlanVersions", fields: [planId], references: [id])
  planId         String?
  images         ArticleImage[]
  magicLinks     MagicLink[]
  aiCosts        AiCost[]
  feedbackRating  Int?
  feedbackComment String?

  @@index([wordpressCategoryId])
  @@index([wordpressAuthorId])
}

model ArticleApprovalToken {
  id         String    @id @default(cuid())
  article    Article   @relation(fields: [articleId], references: [id])
  articleId  String
  token      String    @unique
  expiresAt  DateTime
  consumedAt DateTime?
  createdAt  DateTime  @default(now())
}

model AiPromptConfig {
  id                String   @id @default(cuid())
  task              String
  orderIndex        Int      @default(0)
  systemPrompt      String
  userPrompt        String
  provider          String?
  model             String?
  forceJsonResponse Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([task, orderIndex])
}

model AiCallLog {
  id             String   @id @default(cuid())
  web            Web?     @relation(fields: [webId], references: [id])
  webId          String?
  task           String
  provider       String
  model          String
  variables      Json?
  systemPrompt   String
  userPrompt     String
  responseRaw    Json?
  responseParsed Json?
  status         String
  errorMessage   String?
  createdAt      DateTime @default(now())
}

model SeoStrategy {
  id                     String   @id @default(cuid())
  web                    Web      @relation(fields: [webId], references: [id])
  webId                  String
  model                  String?
  generatedAt            DateTime @default(now())
  rawJson                Json?
  businessName           String?
  businessDescription    String?
  businessTargetAudience String?
  isActive               Boolean  @default(true)
  version                Int      @default(1)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  clusters     SeoTopicCluster[]
  articlePlans ArticlePlan[]

  @@index([webId, isActive])
}

model SeoTopicCluster {
  id             String      @id @default(cuid())
  strategy       SeoStrategy @relation(fields: [strategyId], references: [id])
  strategyId     String
  orderIndex     Int
  pillarPage     String
  pillarKeywords Json
  clusterIntent  String
  funnelStage    String
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  supportingArticles SeoSupportingArticle[]
  articlePlans       ArticlePlan[]

  @@index([strategyId, orderIndex])
}

model SeoSupportingArticle {
  id              String          @id @default(cuid())
  cluster         SeoTopicCluster @relation(fields: [clusterId], references: [id])
  clusterId       String
  orderIndex      Int
  title           String
  keywords        Json
  intent          String
  funnelStage     String
  metaDescription String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  articlePlans ArticlePlan[]

  @@index([clusterId, orderIndex])
}

model ArticlePlan {
  id                  String               @id @default(cuid())
  web                 Web                  @relation(fields: [webId], references: [id])
  webId               String
  strategy            SeoStrategy          @relation(fields: [strategyId], references: [id])
  strategyId          String
  cluster             SeoTopicCluster      @relation(fields: [clusterId], references: [id])
  clusterId           String
  supportingArticle   SeoSupportingArticle @relation(fields: [supportingArticleId], references: [id])
  supportingArticleId String
  article             Article?             @relation("ArticlePlanArticle", fields: [articleId], references: [id])
  articleId           String?              @unique
  versions            Article[]            @relation("ArticlePlanVersions")
  plannedPublishAt    DateTime
  status              ArticlePlanStatus    @default(PLANNED)
  regenerationCount   Int                  @default(0)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt

  @@index([webId, plannedPublishAt])
  @@index([strategyId])
  @@index([status, plannedPublishAt])
}

model ArticleImage {
  id           String      @id @default(cuid())
  article      Article     @relation(fields: [articleId], references: [id], onDelete: Cascade)
  articleId    String
  status       AssetStatus @default(PENDING)
  imageUrl     String?
  prompt       String
  isFeatured   Boolean     @default(false)
  position     Int         @default(0)
  provider     String?
  model        String?
  errorMessage String?
  altText      String?
  fileName     String?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@index([articleId])
  @@index([articleId, isFeatured])
  @@index([articleId, position])
}

model MagicLink {
  id        String   @id @default(cuid())
  token     String   @unique
  webId     String
  web       Web      @relation(fields: [webId], references: [id], onDelete: Cascade)
  articleId String?
  article   Article? @relation(fields: [articleId], references: [id], onDelete: Cascade)
  type      String   // "PUBLISH" | "FEEDBACK"
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  @@index([token])
}

model WebProduct {
  id         String   @id @default(cuid())
  web        Web      @relation(fields: [webId], references: [id], onDelete: Cascade)
  webId      String
  name       String
  url        String?
  price      String?
  currency   String?
  detectedAt DateTime @default(now())
  source     String?  @default("business_profile")

  @@index([webId])
}

enum AiCostType {
  TEXT
  IMAGE
}

model AiCost {
  id           String     @id @default(cuid())
  web          Web        @relation(fields: [webId], references: [id], onDelete: Cascade)
  webId        String
  article      Article?   @relation(fields: [articleId], references: [id], onDelete: SetNull)
  articleId    String?
  provider     String
  model        String
  inputTokens  Int        @default(0)
  outputTokens Int        @default(0)
  totalCost    Float      @default(0)
  currency     String     @default("USD")
  type         AiCostType
  createdAt    DateTime   @default(now())

  @@index([webId])
  @@index([articleId])
  @@index([createdAt])
}
